name: Build and Release AEMultibox

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.1)'
        required: true
        type: string

jobs:
  test:
    name: Test Script Syntax
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup AutoHotkey
        run: |
          # Download AutoHotkey v2 from GitHub releases (more reliable)
          $ahkUrl = "https://github.com/AutoHotkey/AutoHotkey/releases/download/v2.0.18/AutoHotkey_2.0.18.zip"
          Invoke-WebRequest -Uri $ahkUrl -OutFile "AutoHotkey.zip"
          Expand-Archive -Path "AutoHotkey.zip" -DestinationPath "AutoHotkey"
          
          # Copy the executable to the root for easier access
          Copy-Item "AutoHotkey\AutoHotkey64.exe" "AutoHotkey.exe"
          
      - name: Validate AHK Script Syntax
        run: |
          # Test compile without running
          .\AutoHotkey.exe /Validate AEMultibox.ahk
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Script validation failed"
            exit 1
          }
          Write-Host "Script syntax validation passed"
        shell: powershell
        
      - name: Check for required files
        run: |
          $requiredFiles = @(
            "AEMultibox.ahk",
            "README.md"
          )
          
          foreach ($file in $requiredFiles) {
            if (!(Test-Path $file)) {
              Write-Error "Required file missing: $file"
              exit 1
            }
          }
          Write-Host "All required files present"
        shell: powershell

  build:
    name: Build Executable
    needs: test
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup AutoHotkey Compiler
        run: |
          # Download Ahk2Exe compiler
          $ahkUrl = "https://github.com/AutoHotkey/Ahk2Exe/releases/latest/download/Ahk2Exe.zip"
          Invoke-WebRequest -Uri $ahkUrl -OutFile "Ahk2Exe.zip"
          Expand-Archive -Path "Ahk2Exe.zip" -DestinationPath "Ahk2Exe"
          
          # Download AutoHotkey v2 base file from GitHub
          $baseUrl = "https://github.com/AutoHotkey/AutoHotkey/releases/download/v2.0.18/AutoHotkey_2.0.18.zip"
          Invoke-WebRequest -Uri $baseUrl -OutFile "AutoHotkeyBase.zip"
          Expand-Archive -Path "AutoHotkeyBase.zip" -DestinationPath "AutoHotkeyBase"
          Copy-Item "AutoHotkeyBase\AutoHotkey64.exe" "AutoHotkeyU64.exe"
        shell: powershell
        
      - name: Update version in script
        run: |
          $version = if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            "v${{ github.event.inputs.version }}"
          } else {
            "${{ github.ref_name }}"
          }
          
          # Update version in AEMultibox.ahk
          $content = Get-Content "AEMultibox.ahk" -Raw
          $content = $content -replace '; Version: .*', "; Version: $version"
          $content = $content -replace 'global APP_VERSION := ".*"', "global APP_VERSION := `"$version`""
          Set-Content "AEMultibox.ahk" $content
          
          # Create version.txt for auto-updater
          Set-Content "version.txt" $version
          
          Write-Host "Updated to version: $version"
        shell: powershell
        
      - name: Compile to executable
        run: |
          # Compile the script
          .\Ahk2Exe\Ahk2Exe.exe /in AEMultibox.ahk /out AEMultibox.exe /base AutoHotkeyU64.exe /compress 1
          
          if (!(Test-Path "AEMultibox.exe")) {
            Write-Error "Compilation failed - executable not created"
            exit 1
          }
          
          $size = (Get-Item "AEMultibox.exe").Length / 1MB
          Write-Host "Successfully compiled AEMultibox.exe (Size: $([math]::Round($size, 2)) MB)"
        shell: powershell
        
      - name: Create distribution package
        run: |
          # Create dist directory
          New-Item -ItemType Directory -Force -Path "dist"
          
          # Copy main files
          Copy-Item "AEMultibox.exe" "dist/"
          Copy-Item "AEMultibox.ahk" "dist/"
          Copy-Item "version.txt" "dist/"
          Copy-Item "README.md" "dist/"
          
          # Copy AEBoost files if they exist
          if (Test-Path "AEBoost/AEBoost.exe") {
              New-Item -ItemType Directory -Force -Path "dist/AEBoost"
              Copy-Item "AEBoost/*" "dist/AEBoost/" -Recurse
              Write-Host "Included AEBoost integration"
          }
          
          # Create auto-updater script
          Copy-Item "updater.ahk" "dist/" -ErrorAction SilentlyContinue
          
          # Create checksums
          $hash = Get-FileHash "dist/AEMultibox.exe" -Algorithm SHA256
          @"
          File: AEMultibox.exe
          SHA256: $($hash.Hash)
          "@ | Set-Content "dist/checksums.txt"
          
          # Zip the distribution
          Compress-Archive -Path "dist/*" -DestinationPath "AEMultibox-dist.zip" -Force
          
          Write-Host "Distribution package created"
        shell: powershell
        
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: AEMultibox-build
          path: |
            dist/
            AEMultibox-dist.zip
          retention-days: 90

  release:
    name: Create Release
    needs: build
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: AEMultibox-build
          
      - name: Generate release notes
        id: release_notes
        run: |
          $version = if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            "v${{ github.event.inputs.version }}"
          } else {
            "${{ github.ref_name }}"
          }
          
          $notes = @"
          # AEMultibox $version
          
          ## ðŸ“¦ Installation
          1. Download \`AEMultibox-$version.zip\`
          2. Extract to your desired location
          3. (Optional) Place AEBoost files in the \`AEBoost\` subfolder
          4. Run \`AEMultibox.exe\` (or \`AEMultibox.ahk\` if you have AutoHotkey v2 installed)
          
          ## ðŸ”„ Auto-Update
          The application will automatically check for updates on startup. You can also manually check via the Settings tab.
          
          ## âœ¨ What's New
          - See [Changelog](https://github.com/AEMultibox/AEMultibox/blob/main/CHANGELOG.md) for details
          
          ## ðŸ“ Files Included
          - \`AEMultibox.exe\` - Compiled executable (no AutoHotkey required)
          - \`AEMultibox.ahk\` - Source script (requires AutoHotkey v2)
          - \`updater.ahk\` - Auto-updater component
          - \`version.txt\` - Version information
          - \`checksums.txt\` - File integrity verification
          
          ## âš ï¸ Requirements
          - Windows 10/11
          - Ashen Empires game client
          - Administrator privileges recommended for memory reading
          
          ## ðŸ›¡ï¸ Security
          - SHA256 checksum provided in \`checksums.txt\`
          - All releases are automatically built via GitHub Actions
          "@
          
          # Save to file for release
          Set-Content "release_notes.md" $notes
          
          # Output for GitHub
          echo "version=$version" >> $env:GITHUB_OUTPUT
        shell: powershell
        
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_notes.outputs.version }}
          name: AEMultibox ${{ steps.release_notes.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            AEMultibox-dist.zip
            dist/AEMultibox.exe
            dist/AEMultibox.ahk
            dist/version.txt
            dist/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Update latest release pointer
        run: |
          # Create latest.json for auto-updater
          $version = "${{ steps.release_notes.outputs.version }}"
          $downloadUrl = "https://github.com/${{ github.repository }}/releases/download/$version/AEMultibox.exe"
          
          $latest = @{
            version = $version
            download_url = $downloadUrl
            release_date = Get-Date -Format "yyyy-MM-dd"
            checksum = (Get-FileHash "dist/AEMultibox.exe" -Algorithm SHA256).Hash
          } | ConvertTo-Json
          
          Set-Content "latest.json" $latest
          
          Write-Host "Created latest.json for auto-updater"
        shell: powershell
        
      - name: Upload latest.json
        uses: actions/upload-artifact@v3
        with:
          name: latest-version-info
          path: latest.json

  notify:
    name: Notify Success
    needs: [test, build, release]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check status
        run: |
          if [ "${{ needs.test.result }}" == "success" ] && \
             [ "${{ needs.build.result }}" == "success" ] && \
             [ "${{ needs.release.result }}" == "success" ]; then
            echo "Release pipeline completed successfully!"
          else
            echo "Release pipeline failed"
            exit 1
          fi